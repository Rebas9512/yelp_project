name: CI

on:
  push:
    branches: [ "**" ]
  pull_request:
    branches: [ "**" ]
  workflow_dispatch: {}

jobs:
  yelp-ci:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python (for any small host-side helpers)
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python deps (host)
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt || true; fi

      - name: Start docker services (PG + Metabase + Jupyter)
        run: |
          docker compose up -d postgres metabase jupyter
          docker compose ps

      - name: Wait for Postgres
        run: |
          for i in {1..60}; do
            if docker compose exec -T postgres pg_isready -U reader -d yelp_gold >/dev/null 2>&1; then
              echo "✅ Postgres ready"; exit 0
            fi
            sleep 2
          done
          echo "❌ Postgres not ready in time" >&2
          exit 1

      - name: Wait for Metabase health
        run: |
          for i in {1..90}; do
            code=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/api/health || true)
            if [ "$code" = "200" ]; then
              body=$(curl -s http://localhost:3000/api/health)
              echo "$body" | grep -q '"status":"ok"' && { echo "✅ Metabase healthy"; exit 0; }
            fi
            sleep 2
          done
          echo "❌ Metabase not healthy in time" >&2
          exit 1

      - name: Prepare writable exports dir in jupyter container
        run: |
          docker compose exec -u root -T jupyter bash -lc 'mkdir -p /work/exports && chmod -R 777 /work/exports && ls -ld /work/exports'

      - name: Quick export test (CSV only)
        run: |
          docker compose exec -T jupyter bash -lc '
            export PG_HOST=yelp_pg PG_PORT=5432 PG_USER=reader PG_PASSWORD=reader_pw PG_DB=yelp_gold PG_SCHEMA=yelp_gold
            export MB_BASE=http://metabase:3000 MB_EMAIL=admin@yelp.local MB_PASS='"'"'Metabase!2025'"'"'
            python scripts/export_pg_yelp_gold.py --csv --no-ddl
          '

      - name: Collect export artifacts
        run: |
          mkdir -p exports || true
          cid=$(docker compose ps -q jupyter)
          if docker exec "$cid" test -d /work/exports; then
            docker cp "$cid":/work/exports ./exports
          fi
          ls -R exports || true

      - name: Upload exports
        uses: actions/upload-artifact@v4
        with:
          name: exports
          path: exports
          if-no-files-found: warn
          retention-days: 7

      - name: Show logs on failure
        if: failure()
        run: |
          echo "==== Metabase logs ===="
          docker compose logs --no-color metabase | tail -n 400 || true
          echo "==== Postgres logs ===="
          docker compose logs --no-color postgres | tail -n 200 || true